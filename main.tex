%%
%% Copyright (c) 2018 The Authors.  All Rights Reserved.
%%
%% Weitian LI, et al.
%% School of Physics and Astronomy, Shanghai Jiao Tong University,
%% Shanghai, China.
%%
%% 2018-08-23
%%

\documentclass[letters,a4paper,fleqn,usenatbib]{mnras}
% Available options:
% - letters : for papers in the journal's Letters section (<=5 pages)
% - onecolumn : single column
% - doublespacing : double line spacing (do NOT submit in this format)
% - usenatbib : (always use this) use `natbib' package for citations
% - usegraphicx : includes the `graphicx' package
% - useAMS : support 3 upright Greek characters
% - usedcolumn : use `dcolumn' package for table column alignment

\usepackage{newtxtext,newtxmath}
\usepackage[T1]{fontenc}
\usepackage{ae,aecompl}

%
% Custom packages
%
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{siunitx}  % typeset units; from `texlive-science'

\graphicspath{{./}{figures/}}  % NOTE: the trailing '/' matters

\sisetup{
  range-phrase=\text{--},
  range-units=single,
  product-units=power,
  list-separator={, },
  list-final-separator={, and },
}
\DeclareSIUnit\MHz{\mega\hertz}
\DeclareSIUnit\kHz{\kilo\hertz}
\DeclareSIUnit\jansky{Jy}
\DeclareSIUnit\mJy{\milli\jansky}

\def\sectionautorefname{Section}
\def\subsectionautorefname{Section}
\def\figureautorefname{Fig.}
\def\tableautorefname{Table}

%
% Custom commands
%
\newcommand{\Hi}{\ion{H}{i}}
\newcommand{\R}[1]{\mathrm{#1}}


%%======================================================================
%% Title page
%%

%      ............................................. (<=45 chars)
\title[EoR Separation with CDAE]{%
  EoR Signal Separation Using Convolutional Denoising Autoencoder
}

% If you need two or more lines of authors, add an extra line using \newauthor
\author[Li~et~al.]{%
Weitian Li,$^{1}$\thanks{E-mail:
  \href{mailto:liweitianux@sjtu.edu.cn}{liweitianux@sjtu.edu.cn} (WL);
  \href{mailto:hgxu@sjtu.edu.cn}{hgxu@sjtu.edu.cn} (HX)}
Haiguang Xu,$^{1,2,3}$\footnotemark[1]
Zhixian Ma,$^{4}$
Ruimin Zhu,$^{5}$
Dan Hu,$^{1}$
Zhenghao Zhu,$^{1}$
\newauthor
Chenxi Shan,$^{1}$
Jie Zhu$^{4}$
and
Xiang-Ping Wu$^{6}$
\\
% List of institutions
$^{1}${School of Physics and Astronomy,
  Shanghai Jiao Tong University,
  800 Dongchuan Road, Shanghai 200240, China} \\
$^{2}${Tsung-Dao Lee Institute,
  Shanghai Jiao Tong University,
  800 Dongchuan Road, Shanghai 200240, China} \\
$^{3}${IFSA Collaborative Innovation Center,
  Shanghai Jiao Tong University,
  800 Dongchuan Road, Shanghai 200240, China} \\
$^{4}${Department of Electronic Engineering,
  Shanghai Jiao Tong University,
  800 Dongchuan Road, Shanghai 200240, China} \\
$^{5}${Department of Statistics,
  Northwestern University,
  2006 Sheridan Road, Evanston, IL 60208, US} \\
$^{6}${National Astronomical Observatories,
  Chinese Academy of Sciences,
  20A Datun Road, Beijing 100012, China}
}

% These dates will be filled out by the publisher
\date{Accepted XXX. Received YYY; in original form ZZZ}

% Enter the current year, for the copyright statements etc.
\pubyear{2018}

% Don't change these lines
\begin{document}
\label{firstpage}
\pagerange{\pageref{firstpage}--\pageref{lastpage}}
\maketitle

%
% Abstract
% (<=200 words for Letters)
%
\begin{abstract}
The \SI{21}{\cm} emission from the neutral hydrogen (\ion{H}{i})
is regarded as the decisive probe to explore the epoch of reionization.
\end{abstract}

% Select between one and six entries from the list of approved keywords.
% Don't make up new ones.
% https://academic.oup.com/DocumentLibrary/mnras/keywords.pdf
\begin{keywords}
methods: data analysis --
techniques: interferometric --
dark ages, reionization, first stars --
radio continuum: general
\end{keywords}


%%======================================================================
%% Paper body
%%

\section{Introduction}
\label{sec:intro}

The epoch of reionization (EoR; $z \sim \numrange{6}{15}$) is a period
of the Universe that is still poorly understood.
The \SI{21}{\cm} line emission of the neutral hydrogen (\Hi), which is
redshifted to frequencies below \SI{200}{\MHz}, is regarded as the
decisive probe to directly explore the EoR
\citep[see][for reviews]{furlanetto2006rev,furlanetto2016rev}.
In order to probe the EoR, several low-frequency radio interferometers
are built or to be built to target the \SI{21}{\cm} signal, among which
there are 21CMA \citep{zheng2016}, MWA \citep{tingay2013},
LOFAR \citep{vanHaarlem2013}, PAPER \citep{parsons2010},
HERA \citep{deboer2017}, and SKA \citep{koopmans2015rev}.
The observational challenges, however, are immense due to a variety of
complicated instrumental effects, ionospheric distortions, radio frequency
interference, and the strong astronomical foreground contamination that
overwhelms the EoR signal by about \numrange{4}{5} orders of magnitudes
\citep[see][for a review]{morales2010rev}.

Fortunately, the severe foreground contamination is expected to be
spectrally smooth, while the EoR signal fluctuates rapidly along the
frequency dimension.
This important difference is the key characteristic exploited by many
foreground removal methods in order to uncover the faint EoR signal in
the presence of overwhelming foreground contamination, including the
parametric fitting methods \citep[e.g.,][]{wang2006,liu2009fgrm,wang2013}
and non-parametric methods \citep[e.g.,][]{harker2009,chapman2013,mertens2018}.

However, the frequency-dependent beam effects can damage the smoothness
of the foreground spectrum \citep{liu2009ps}.
The synthesised beam, which is also called the point spread function (PSF)
and is the Fourier transform of the interferometer layout, has jagged
side-lobes extending far beyond the central peak due to the incomplete
$uv$ coverage.
In addition, both the shape and response of the beams vary with
observing frequencies.
Therefore, any unresolved or mis-subtracted foreground sources leave
rapidly oscillating residuals along the frequency dimension, which may
seriously compromise the separation of the EoR signal.

Given the complexity of beam profiles, it is extremely difficult to
craft a parametric model for existing foreground removal methods to
overcome the intricate beam effects.
The data-driven modelling method is thus more feasible and appealing.
In recent years, the deep learning algorithms have seen prosperous
developments and brought breakthroughs into a variety of fields, such
as image classification, speech recognition, and object detection
\citep{lecun2015}.
Among all kinds of neural network architectures, the autoencoder
aims to learn robust features in the data \citep{vincent2008}
and has been widely applied to
dimensionality reduction \citep{hinton2006},
image inpainting and denoising \citep{suganuma2018},
speech separation \citep{grais2017}, and so on.

In this paper, we propose a novel method to separate the EoR signal by
making use of the convolutional denoising autoencoder (CDAE), a common
variant of autoencoders that is designed to learn noise robust features.
We introduce the CDAE and elaborate the proposed method in
\autoref{sec:method}.
The method is then applied to the simulated SKA image cubes to
evaluate its performance, as demonstrated in \autoref{sec:experiments},
where we also carry out a comparison of performance between our
deep-learning-based method and traditional polynomial fitting method.
Finally, we conclude our work in \autoref{sec:conclusions}.


%%======================================================================
\section{Methodology}
\label{sec:method}

%%----------------------------------------------------------------------
\subsection{Convolutional denoising autoencoder}
\label{sec:cdae}

The autoencoder is an unsupervised learning algorithm and consists of
two parts: the encoder and the decoder.
The former learns codes that can effectively represent the input data,
while the latter reconstructs the input from the learned codes.
By constraining the dimensionality or sparsity of the codes, the
autoencoder is forced to learn robust features from the training data
\citep[chapter 14]{goodfellow2016}.

The convolutional autoencoder (CAE) is a variant of autoencoders that
makes use of convolutional layers instead of fully connected layers
\citep{masci2011}.
Each convolutional layer consists of a series of filters and learns
a set of localised features.
More sophisticated features can thus be hierarchically built by stacking
multiple convolutional layers.
The weights (i.e., parameters) of filters are shared across all
locations in the input data, which greatly reduces the number of
parameters and eases the training.
This makes it possible to implement very deep and expressive CAEs that
can extract intricate features from the data.
In order to learn more robust features, the CAE can be trained to
predict the original data from the noisy or corrupted data, hence the
so-called convolutional denoising autoencoder (CDAE).

In the task of separating the EoR signal, the foreground contamination
can be regarded as the noise that corrupts the target signal.
A CDAE can therefore be trained to learn noise-robust features of the
faint EoR signal and reconstruct it, achieving the effective separation
of the EoR signal from the overwhelming foreground contamination.


%%----------------------------------------------------------------------
\subsection{Network architecture}
\label{sec:architecture}

We propose a simple deep CDAE for separating the EoR signal, as shown
in \autoref{fig:network}.
The CDAE consists of a 7-layer encoder, a 7-layer decoder,
and one output layer.
The encoder and decoder parts are symmetric and use the rectified
linear unit (ReLU) as the activation function, while the output layer
uses the `tanh' activation function (see also \autoref{sec:data}).
All the convolutional layers have filters of size 3 and the filters
are one-dimensional (1D) because of the 1D input data, i.e., along the
observing frequency dimension.

\begin{figure}
  \centering
  \includegraphics[width=\columnwidth]{network-crop}
  \caption{\label{fig:network}%
    The network architecture of the proposed CDAE that
    predicts the clean EoR signal from the noisy signal corrupted by
    the foreground.
    The CDAE consists of a 7-layer encoder (the orange boxes),
    a 7-layer decoder (the blue boxes), and one output layer
    (the green box).
    All the convolutional layers use 1D filters of size 3, and
    the number of filters in each layer is shown in the boxes
    with bold font.}
\end{figure}


%%----------------------------------------------------------------------
\subsection{Data preprocessing}
\label{sec:data}

To better train the CDAE, the data should be appropriately preprocessed.
The raw input data are an image cube that covers a frequency band and
contains both the EoR signal and severe foreground contamination.
Each pixel of the image cube is represented by a vector, which is on
data point to be input to the CDAE.
Given the important difference in spectral structures between the EoR
signal and the foreground emission, we apply the Fourier Transform to
the raw data along the frequency dimension to make the EoR signal more
distinguishable and easier to learn by the CDAE.
The Blackman-Nuttall window function is applied to suppress the side-lobes
in the Fourier Transform caused by the sharp discontinuities at the ends
of the finite frequency band \citep[e.g.,][]{chapman2016}.
The $n_{\R{ex}}$ lowest Fourier components, which generally have large
values and are almost contributed by the spectral-smooth foreground
emission, are excised not only to avoid the higher Fourier components
where the EoR signal mainly resides being overwhelmed, but also to
make the pixels have similar weights to the CDAE.
To be able to reconstruct the separated EoR signal, both the real and
imaginary parts of the Fourier coefficients must be used in the CDAE,
therefore, the real and imaginary parts are separated and concatenated
into a new vector.
Finally, the data are zero-centred and normalised to have unit variance.

On the other hand, the preprocessing steps for the labelled data (i.e.,
the image cube of the EoR signal only) are similar to the above steps
but need minor adjustments.
After applying the Fourier Transform, excising the $n_{\R{ex}}$ lowest
components, and concatenating the real and imaginary parts,
the labelled data are truncated within the 1$^{\R{th}}$ and 99$^{\R{th}}$
percentiles to remove the possible outliers, and then divided by the
maximum absolute value of the truncated data.
In this way, the sign of the labelled data is preserved for the purpose
of reconstruction and the value range is constrained within $[-1, 1]$,
which allows us to use the `tanh' activation function for the output
layer in the CDAE.


%%----------------------------------------------------------------------
\subsection{Training}
\label{sec:training}

The loss function describes the difference between the output of the
CDAE and the labelled data.
By training the CDAE to minimise the loss function, the CDAE is able
to predict the expected output from the input data.
In this work, the loss function is chosen to be the `mean squared error.'
The CDAE is initialised by the Glorot uniform initialiser \citep{glorot2010}
and is trained using the Adam optimisation method \citep{kingma2015}.


%%----------------------------------------------------------------------
\subsection{Evaluation index}
\label{sec:index}

To evaluate the performance of separating the EoR signal, the Pearson's
correlation coefficient is adopted to measure the similarity between
the separated signal $\mathbf{s}_p$ and the ground truth $\mathbf{s}_t$
(i.e., the labelled data):
\begin{equation}
  \label{eq:corrcoef}
  \rho(\mathbf{s}_p, \mathbf{s}_t) =
    \frac{\sum_{i=1}^{n}(s_{p,i}-\bar{s}_p)(s_{t,i}-\bar{s}_t)}{
      \sqrt{\sum_{i=1}^{n}(s_{p,i}-\bar{s}_p)^2
        \sum_{i=1}^{n}(s_{t,i}-\bar{s}_t)^2}
    },
\end{equation}
where $\bar{s}_p$ and $\bar{s}_t$ are the mean values.
The closer the correlation coefficient is to one, the better the
performance of separation.


%%======================================================================
\section{Experiments}
\label{sec:experiments}

%%----------------------------------------------------------------------
\subsection{Data simulation}
\label{sec:simulation}

In order to derive the data set to train the proposed CDAE and evaluate
its performance, we carry out end-to-end simulations to generate the
`observed' image cubes.
Specifically, we take the \SIrange{154}{162}{\MHz} frequency band as an
example and simulate the sky images of the EoR signal and the foreground
contamination, which includes Galactic synchrotron and free-free
emissions, extragalactic point sources, and radio haloes.
The SKA1-Low layout configuration is employed to simulate the SKA
`observed' images.
In this way, we take into account the complicated instrumental effects
of radio interferometers.
See \citet{li2018} for the details.

\begin{figure}
  \centering
  \includegraphics[width=\columnwidth]{simudata}
  \caption{\label{fig:simudata}%
    The spectra of two example pixels in the simulated image cubes
    of the EoR signal (the top panel) and the foreground emission
    (the bottom panel).
    The absolute differences between two adjacent frequencies are
    also plotted for the foreground emission in thin lines.
  }
\end{figure}

To generate the best-quality images for performing the EoR signal
separation, we make the following minor adjustments to the simulation
pipeline presented in \citet{li2018}.
(1) The frequency resolution is improved to be \SI{80}{\kHz} to better
preserve the spectral structures of the EoR signal, thus the chosen
\SIrange{154}{162}{\MHz} frequency band has 101 channels.
(2) The bright point sources that have a flux density
$S_{158} > \SI{10}{\mJy}$ at \SI{158}{\MHz} are assumed to be
removed \citep[e.g.,][]{liu2009ps}.
(3) The images are created from the visibility data using the natural
weighting method and baseline range of \numrange{30}{1000} wavelengths
to emphasise the faint diffuse EoR signal.
(4) Only the central \SI[product-units=repeat]{2 x 2}{\degree} regions
(i.e., \num{360 x 360} pixels with a pixel size of \SI{20}{\arcsecond})
of the created images are cropped out for use in this work.
Therefore, we obtain two image cubes of dimension \num{360 x 360 x 101}
for the EoR signal and the foreground contamination, respectively.
The spectra of two example pixels are shown in \autoref{fig:simudata},
where the absolute differences between two adjacent frequencies are
also plotted for the foreground emission.
It is clearly shown that the spectral smoothness is seriously damaged
by the complicated instrumental effects.

The input data for the CDAE are the addition of the two image cubes,
i.e., both the EoR signal and the foreground contamination,
and the labelled data are the image cube of the EoR signal.
The total number of data points in this data set, i.e., the number of
pixels of the image cubes, is 129,600.


%%----------------------------------------------------------------------
\subsection{Method implementation}
\label{sec:implementation}

We first preprocess the simulated data according to the steps described
in \autoref{sec:data}.
The number of lowest Fourier components to excise ($n_{\R{ex}}$) is
set to 6, thus the length of each preprocessed data point is 90.
The data set is then randomly divided into two parts:
(1) the training set, which has 103,680 data points, accounting for
80 per cent of the whole data set;
(2) the validation set, containing the remaining 25,920 data points.

We implement the CDAE using the \textsc{Keras} framework \citep{keras}
with the \textsc{TensorFlow} back end \citep{tensorflow}.
The parameters of Adam optimisation method are set to the recommended
default values, i.e., learning rate being $\alpha = 0.001$, and
exponential decay rates for the first and second moment estimates being
$\beta_1 = 0.9$ and $\beta_2 = 0.999$, respectively \citep{kingma2015}.
The batch size is 100, and the CDAE is trained for 100 epochs.

All the code and data are made public at
\url{https://github.com/lwieitianux/cdae-eor}.


%%----------------------------------------------------------------------
\subsection{Results}
\label{sec:results}

\begin{figure}
  \centering
  \includegraphics[width=\columnwidth]{cdae-train}
  \caption{\label{fig:train}%
    The correlation coefficient evaluated on the validation set (the
    solid green line with the shaded region showing the standard
    deviation), training loss (the solid red line), and validation loss
    (the solid blue line) during the CDAE training.
  }
\end{figure}

The losses and the correlation coefficient evaluated on the validation
set during the CDAE training are shown in \autoref{fig:train}.
The steadily decreasing losses and increasing correlation coefficient
suggest that the CDAE is well trained.
After training for 100 epochs, the CDAE achieves excellent performance
with a correlation coefficient of \num{0.985 +- 0.009} on the validation
set.
An example of the EoR signal separated by the trained CDAE is presented
in \autoref{fig:result}.
This separation example has a correlation coefficient of 0.985 and well
demonstrates that the faint EoR signal can be separated with high
accuracy by the CDAE.
Consequently, our deep-learning-based method by using the CDAE is able
to accurately separate the faint EoR signal in the presence of severe
foreground contamination and complicated instrumental effects.

\begin{figure}
  \centering
  \includegraphics[width=\columnwidth]{eor-result}
  \caption{\label{fig:result}%
    An example of the EoR signal separated by the trained CDAE.
    \textbf{(top)} The labelled EoR signal (i.e., the ground truth;
    the blue line) and the separated EoR signal (the green line) in the
    Fourier domain where the CDAE training is performed.
    The grey line represents the input data to the CDAE that contains
    both the EoR signal and the foreground contamination.
    The magenta hatched region marks the lowest Fourier components that
    are excised in data preprocessing.
    \textbf{(bottom)} The labelled EoR signal (the blue line) and the
    separated EoR signal (the green line) transformed back to the
    observing frequency domain.
    The signals are very different from those shown in
    \autoref{fig:simudata}(a) because the Blackman-Nuttall window is
    applied along the frequency domain.
  }
\end{figure}


%%----------------------------------------------------------------------
\subsection{Comparison}
\label{sec:comparison}

Compare to the traditional polynomial fitting method ...


%%======================================================================
\section{Conclusions}
\label{sec:conclusions}

We have proposed a CDAE to separate the faint EoR signal along the
frequency dimension and achieved excellent results...


%%======================================================================
\section*{Acknowledgements}

This work is supported by
the Ministry of Science and Technology of China
(grant No. 2018YFA0404601),
the National Natural Science Foundation of China
(grant Nos. 11433002, 11621303, 61371147),
and the National Key Research and Discovery Plan
(grant No. 2017YFF0210903).


%%======================================================================
%% References

\bibliographystyle{mnras}
\bibliography{references}


%%======================================================================
%% Appendix

% \appendix


%%======================================================================
% Don't change these lines
\bsp	% typesetting comment
\label{lastpage}
\end{document}

%% EOF
